<!doctype html>
  <html lang=en>
  <head>
    <meta charset=utf-8>
    <title>FHIR IG Builds</title>
    <link rel="stylesheet" href="bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="timeago.js"></script>
    <script src="sortable.js"></script>
    <style>
      th {text-decoration: underline; cursor: pointer}
    </style>
  </head>
  <body>
    <div class="container">
    <h2>FHIR IG Builds</h2>
    <table id="builds" class="table table-striped"></table>
  </div>
  </body>
  <script>
    var state = {
      builds: [],
      qas: []
    },
    timeFormatter = timeago(),
    buildsTable = document.getElementById("builds");

    fetch("https://build.fhir.org/ig/builds.json")
      .then(r => r.json())
      .then(fetchBuilds)
      .then(renderBuilds);

    fetch("https://build.fhir.org/ig/qa.json")
      .then(r => r.json())
      .then(fetchQas)
      .then(renderQas);

    function renderBuilds(builds) {
      state.builds = builds;
      render(state);
    }

    function fetchBuilds(builds) {
      return Promise.all(builds.map(repo =>
        fetch("https://build.fhir.org/ig/"+repo)
          .then(b => b.text())
        .then(b => {
          var date = b.match(/ @ (.*)\n/),
              version = b.match(/Definitions (\S+)/);

          date = date && new Date(date[1]) || null;
          version = version && version[1] || null;

          return {
            repo: repo.replace("/build.log",""),
            date: date,
            version: version
          }})));
    }

    function fetchQas(qas) {
      return Promise.all(qas.map(repo =>
        fetch("https://build.fhir.org/ig/"+repo)
          .then(b => b.text())
        .then(b => {
          var date = b.match(/Generated (.*?)\./),
              version = b.match(/FHIR version (.*)\</);

          date = date && new Date(date[1]) || null;
          version = version && version[1] || null;

          return {
            repo: repo.replace("/qa.html", ""),
            date: date,
            version: version
          }})));
    }

    function renderQas(qas) {
      state.qas = qas;
      render(state);

    }

    function rebuild(repo) {
      fetch("https://us-central1-fhir-org-starter-project.cloudfunctions.net/ig-commit-trigger", {
        body: JSON.stringify({"repository": {"full_name": repo}}),
        headers: {
          'Content-Type': 'application/json'
        },
        method: 'POST',
        referrer: 'no-referrer',
        mode: 'cors'
      })
      document.getElementById(repo).setAttribute("disabled", "true")
    }

 
  function render({builds, qas}){

    var table = state.qas.map(e=>e.repo)
      .reduce((acc, entry) => {
        acc[entry] = {
          build: builds.filter(b=>b.repo === entry)[0],
          qa: qas.filter(b=>b.repo === entry)[0]
        };
        return acc
    }, {})

    rows = Object.keys(table)
      .sort((a, b) => a.toLocaleLowerCase() < b.toLocaleLowerCase() ? -1 : 1)
      .map(r => table[r])
      .map(r => {return {
        org: r.qa.repo.split("/")[0],
        repo: r.qa.repo.split("/")[1],
        qaDate: r.qa.date,
        qaVersion: r.qa && r.qa.version,
        success: !!r.qa
      }})

    var tbody = `<thead>
        <th>ig</th>
        <th>qaVersion</th>
        <th>qaDate</th>
        <th>success</th>
        <th>links</th>
      </thead><tr>` + rows.map(({org, repo, qaDate, qaVersion, success}) =>
        `<td>
        <a target="_blank" href="https://build.fhir.org/ig/${org}/${repo}">
        ${org}/<strong>${repo}</strong></a>
        </td>
        <td>${qaVersion}</td>
        <td sorttable_customkey="${qaDate.toISOString()}">
        <a data-toggle="tooltip" title="${qaDate && qaDate.toISOString()}">${timeFormatter.format(qaDate)}</td>
        <td>${success}</td>
        <td><button id="${org}/${repo}" class="btn" onClick="rebuild('${org}/${repo}')">Rebuild</button>
        <a target="_blank" class="btn btn-primary btn-sm" href="https://build.fhir.org/ig/${org}/${repo}/build.log">log</a>
        <a target="_blank" class="btn btn-primary btn-sm" href="https://github.com/${org}/${repo}">gh</a>
        </td>`
    ).join(`</tr><tr>`)

    buildsTable.innerHTML = tbody;
    sorttable.makeSortable(buildsTable);
  }
  </script>
</html>
