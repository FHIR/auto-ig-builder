# FHIR IG Builder - Unified Kubernetes Setup

This setup supports both local development and production GCloud deployments with a single set of configuration files and scripts.

## Quick Start

### GCloud Production (Default)
```bash
cd k8s
./setup.sh
./build-images.sh
kubectl apply -f ../mount/ci-build.deployment.generated.yaml
```

### Local Development (Recommended - Choose Your Cluster Type)

```bash
cd k8s

# Choose one cluster setup method:
./setup-minikube.sh    # minikube
# OR
./setup-kind.sh        # KIND
# OR  
./setup-k3s.sh         # k3s
# OR
./setup-kubeadm.sh     # existing kubeadm cluster

# Then follow unified setup process (same for all):
./setup.sh --type [minikube|kind|k3s|kubeadm]
./build-images.sh --type [minikube|kind|k3s|kubeadm]
kubectl apply -f ../mount/ci-build.deployment.generated.yaml
```

### Local Development (Manual)

```bash
cd k8s
./setup.sh --type local
./build-images.sh --type local --push false
kubectl apply -f ../mount/ci-build.deployment.generated.yaml
```

## Scripts Overview

| Script | Purpose | Status |
|--------|---------|---------|
| `setup.sh` | **PRIMARY** - Unified setup for all deployment types (local, minikube, kind, k3s, kubeadm, gcloud) - **Run BEFORE build-images.sh** | ✅ Active |
| `build-images.sh` | **PRIMARY** - Build and push Docker images with deployment-specific configurations - **Run AFTER setup.sh** | ✅ Active |
| `setup-minikube.sh` | **minikube** - Start minikube cluster for unified setup process | ✅ Active |
| `setup-kind.sh` | **KIND** - Create KIND cluster for unified setup process | ✅ Active |
| `setup-k3s.sh` | **k3s** - Start k3s cluster for unified setup process | ✅ Active |
| `setup-kubeadm.sh` | **kubeadm** - Prepare existing kubeadm cluster for unified setup process | ✅ Active |
| `create.sh` | Redirect to `setup.sh --type gcloud` | ⚠️ Deprecated |

## Configuration Files

| File | Purpose |
|------|---------|
| `ci-build.deployment.template.yaml` | Template for deployment generation |
| `../mount/ci-build.deployment.generated.yaml` | Generated deployment (created by setup.sh) |
| `persistent-volumes.template.yaml` | Template for local persistent volumes |
| `../mount/kubeadm-persistent-volumes.yaml` | kubeadm-specific persistent volumes (generated by setup-kubeadm.sh) |
| `../mount/kubeadm-node-selector.yaml` | kubeadm node selector configuration (generated by setup-kubeadm.sh) |
| `kubeadm-examples.yaml` | Example configurations for kubeadm storage provisioners and ingress |
| `ci-build.configmap.yaml` | ConfigMap for CI build configuration |
| `ci-build.service.yaml` | Service definition |
| `kind-config.yaml` | Configuration for kind clusters |

## Migration from Old Setup

The setup has been unified into two primary scripts. The old scripts now redirect to the new ones:

```bash
# Old way → New way (still works)
./create.sh          →  ./setup.sh --type gcloud
```

**Recommendation**: Update your scripts to use `./setup.sh` directly as the deprecated scripts will be removed in a future release.

**Important**: Always run `./setup.sh` before `./build-images.sh` - the build script depends on configuration files created by setup.

## Environment Variables

Both scripts support these environment variables:

- `DEPLOYMENT_TYPE`: `minikube`, `kind`, `k3s`, `kubeadm`, `local`, or `gcloud` (default: `gcloud`)
- `REGISTRY_PREFIX`: Container registry prefix (default: `gcr.io/fhir-org-starter-project` for gcloud, `localhost:5000` for local types)
- `NAMESPACE`: Kubernetes namespace (default: `fhir`)
- `ZULIP_EMAIL`: Email for notifications
- `ZULIP_API_KEY`: API key for notifications

## Examples

### Complete Local Setup with Minikube

```bash
# Start minikube cluster
./setup-minikube.sh

# Follow unified setup process
./setup.sh --type minikube
./build-images.sh --type minikube

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml

# Test
kubectl apply -f example-job-for-minikube.yaml
```

### Complete Local Setup with KIND

```bash
# Create KIND cluster
./setup-kind.sh

# Follow unified setup process
./setup.sh --type kind
./build-images.sh --type kind

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml

# Test
kubectl apply -f example-job-for-minikube.yaml
```

### Complete Local Setup with k3s

```bash
# Start k3s cluster
./setup-k3s.sh

# Follow unified setup process
./setup.sh --type k3s
./build-images.sh --type k3s

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml

# Test
kubectl apply -f example-job-for-minikube.yaml
```

### Complete kubeadm Setup

```bash
# Prepare existing kubeadm cluster
./setup-kubeadm.sh

# Follow unified setup process
./setup.sh --type kubeadm
./build-images.sh --type kubeadm

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml

# Test
kubectl apply -f example-job-for-minikube.yaml
```

### Generic Local Setup (Legacy)

```bash
# For any local cluster (manual setup)
./setup.sh --type local
./build-images.sh --type local --push false

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml

# Test
kubectl apply -f example-job-for-minikube.yaml
```

**Note**: All four local deployment types (minikube, KIND, k3s, kubeadm) follow the same unified 3-step setup process after initial cluster preparation. The `local` type is a generic fallback for manual setups.

### Complete GCloud Setup

```bash
# Connect to GCloud
gcloud container clusters get-credentials fhir-k8s --zone us-east1-d

# Setup with production credentials
export ZULIP_EMAIL="production-bot@example.com"
export ZULIP_API_KEY="real-api-key"

cd k8s
./setup.sh --type gcloud
./build-images.sh --type gcloud

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml
```

### Local with Custom Registry

```bash
# Start local registry
docker run -d -p 5000:5000 --name registry registry:2

# Setup and build
cd k8s
./setup.sh --type local --registry localhost:5000
./build-images.sh --type local --registry localhost:5000

# Deploy
kubectl apply -f ../mount/ci-build.deployment.generated.yaml
```

## Troubleshooting

### Minikube-Specific Issues

**Image Pull Errors:**
```bash
# Ensure Docker environment is set
eval $(minikube docker-env)

# Verify images exist
docker images | grep -E "(ig-publisher|ci-build|caddy-ratelimit)"

# Rebuild if missing
./build-images.sh --type minikube
```

**Resource Issues:**
```bash
# Check minikube resources
minikube status
kubectl top nodes

# Increase memory if needed
minikube stop
minikube start --memory=8192 --cpus=4
```

### KIND-Specific Issues

**Image Loading Failures:**
```bash
# Manually load images if automatic loading fails
kind load docker-image ig-publisher:latest --name fhir-ig-builder
kind load docker-image ci-build:latest --name fhir-ig-builder
kind load docker-image caddy-ratelimit:latest --name fhir-ig-builder
```

**Port Conflicts:**
```bash
# Check for port conflicts
lsof -i :8080
netstat -tulpn | grep 8080

# Delete and recreate cluster if needed
kind delete cluster --name fhir-ig-builder
./setup-kind.sh
```

### k3s-Specific Issues

**Service Startup Failures:**
```bash
# Check k3s service status
sudo systemctl status k3s
sudo journalctl -u k3s --no-pager -l

# Restart if needed
sudo systemctl restart k3s
```

**KUBECONFIG Issues:**
```bash
# Verify KUBECONFIG is set correctly
echo $KUBECONFIG
kubectl cluster-info

# Reset if needed
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
sudo chmod 644 $KUBECONFIG
```

**Data Directory Permissions:**
```bash
# Fix k3s data directory permissions
sudo chown -R $(whoami):$(whoami) /var/lib/rancher/k3s
sudo chmod -R 755 /var/lib/rancher/k3s
```

### kubeadm-Specific Issues

**Storage Provisioner Problems:**
```bash
# Check storage classes
kubectl get storageclass

# Install local-path provisioner if missing
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.24/deploy/local-path-storage.yaml

# Or use our examples
kubectl apply -f kubeadm-examples.yaml
```

**Node Selector Issues:**
```bash
# Check node labels
kubectl get nodes --show-labels

# Apply node selector if needed
kubectl apply -f kubeadm-node-selector.yaml
```

**CNI/Networking Issues:**
```bash
# Check pod network
kubectl get pods -n kube-system
kubectl describe pod <cni-pod-name> -n kube-system

# Test connectivity
kubectl run test-pod --image=busybox --rm -it -- ping 8.8.8.8
```

### Cross-Platform Issues

**Persistent Volume Mounting Failures:**
```bash
# Check PV status
kubectl get pv
kubectl get pvc -n fhir
kubectl describe pvc <pvc-name> -n fhir

# Check node storage
df -h
sudo du -sh /tmp/fhir-*
```

**Registry Connectivity Problems:**
```bash
# Test registry access
docker pull localhost:5000/ig-publisher:latest
curl -v http://localhost:5000/v2/_catalog

# Start local registry if missing
docker run -d -p 5000:5000 --name registry registry:2
```

**Resource Quota Issues:**
```bash
# Check resource usage
kubectl top pods -n fhir
kubectl describe limitrange -n fhir
kubectl describe quota -n fhir

# Check node capacity
kubectl describe nodes
```

**Service Discovery Problems:**
```bash
# Check services and endpoints
kubectl get svc -n fhir
kubectl get endpoints -n fhir
kubectl describe svc ci-build-service -n fhir

# Test internal connectivity
kubectl run debug-pod --image=busybox --rm -it -n fhir -- nslookup ci-build-service
```

### GCloud-Specific Issues

**Permission Errors:**
```bash
# Verify GCloud authentication
gcloud auth list
gcloud auth application-default login

# Check cluster access
kubectl get nodes
gcloud container clusters get-credentials fhir-k8s --zone us-east1-d
```

**Missing Secrets:**
```bash
# Verify secrets exist
kubectl get secrets -n fhir
kubectl describe secret fhir-settings -n fhir

# Check environment variables
echo $ZULIP_EMAIL
echo $ZULIP_API_KEY
```

## Cleanup Procedures

### Universal Cleanup (All Types)

```bash
# Remove Kubernetes resources
kubectl delete namespace fhir

# Remove generated files
rm -f ../mount/ci-build.deployment.generated.yaml
rm -f ../mount/kubeadm-persistent-volumes.yaml
rm -f ../mount/kubeadm-node-selector.yaml
rm -f ../mount/id
rm -f ../mount/id.pub
```

### Minikube Cleanup

```bash
# Stop cluster
minikube stop

# Delete cluster (complete removal)
minikube delete

# Clean Docker environment
unset DOCKER_TLS_VERIFY DOCKER_HOST DOCKER_CERT_PATH MINIKUBE_ACTIVE_DOCKERD

# Remove minikube cache (optional)
rm -rf ~/.minikube
```

### KIND Cleanup

```bash
# Delete cluster
kind delete cluster --name fhir-ig-builder

# Remove KIND images (optional)
docker rmi $(docker images --format "table {{.Repository}}:{{.Tag}}" | grep -E "(kindest|kind)")

# Clean up KIND networks
docker network prune
```

### k3s Cleanup

```bash
# Stop k3s service
sudo systemctl stop k3s
sudo systemctl disable k3s

# Remove k3s data directory
sudo rm -rf /var/lib/rancher/k3s
sudo rm -rf /etc/rancher/k3s

# Uninstall k3s (if needed)
sudo /usr/local/bin/k3s-uninstall.sh

# Clean environment
unset KUBECONFIG
```

### kubeadm Cleanup

```bash
# Remove namespace and resources
kubectl delete namespace fhir

# Remove persistent volumes
kubectl delete pv --selector=app=fhir-ig-builder

# Clean up storage directories
sudo rm -rf /tmp/fhir-*

# Remove storage classes (if you created them)
kubectl delete storageclass local-path

# Reset kubeadm (complete cluster reset)
# WARNING: This removes the entire cluster
# sudo kubeadm reset
# sudo rm -rf /etc/kubernetes/
# sudo rm -rf /var/lib/etcd/
```

### Local Registry Cleanup

```bash
# Stop and remove local registry
docker stop registry
docker rm registry

# Remove registry images
docker rmi localhost:5000/ig-publisher:latest
docker rmi localhost:5000/ci-build:latest
docker rmi localhost:5000/caddy-ratelimit:latest

# Clean registry data
docker volume prune
```

### GCloud Cleanup

```bash
# Remove namespace (keeps cluster)
kubectl delete namespace fhir

# Clean up Cloud Build images (optional)
gcloud container images list --repository=gcr.io/fhir-org-starter-project
gcloud container images delete gcr.io/fhir-org-starter-project/ig-publisher:latest
```

## Diagnostic Commands

### General Cluster Health

```bash
# Cluster info
kubectl cluster-info
kubectl get nodes
kubectl get pods --all-namespaces

# Resource usage
kubectl top nodes
kubectl top pods -n fhir

# Events
kubectl get events -n fhir --sort-by='.lastTimestamp'
```

### Application-Specific Debugging

```bash
# Check deployment status
kubectl get deployments -n fhir
kubectl describe deployment ci-build-deployment -n fhir

# Pod logs
kubectl logs -l app=ci-build -n fhir
kubectl logs deployment/ci-build-deployment -n fhir --follow

# Pod shell access
kubectl exec -it deployment/ci-build-deployment -n fhir -- /bin/bash

# Network testing
kubectl port-forward service/ci-build-service 8080:80 -n fhir
curl http://localhost:8080/
```

### Storage Debugging

```bash
# Check storage
kubectl get pv,pvc -n fhir
kubectl describe pvc fhir-volume-claim -n fhir

# Check storage classes
kubectl get storageclass
kubectl describe storageclass local-path

# Node storage
df -h
lsblk
```
